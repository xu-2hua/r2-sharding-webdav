<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudDisk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 text-gray-900">
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i data-lucide="cloud" class="text-blue-600"></i>
                <span class="font-bold text-lg">CloudDisk</span>
            </div>
            <div class="flex space-x-4">
                <a href="/admin/index.html" class="text-sm text-gray-500 hover:text-blue-600 pt-2">管理后台</a>
                <button onclick="document.getElementById('fileUpload').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm flex items-center hover:bg-blue-700">
                    <i data-lucide="upload" class="w-4 h-4 mr-2"></i> 上传
                </button>
                <input type="file" id="fileUpload" class="hidden" onchange="handleUpload(this)">
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-6">
        <div id="breadcrumbs" class="flex items-center text-sm text-gray-500 mb-4"></div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-gray-50 text-xs font-semibold text-gray-500 uppercase border-b">
                <div class="col-span-8">名称</div>
                <div class="col-span-2 text-right hidden md:block">大小</div>
                <div class="col-span-2 md:col-span-2 text-right">操作</div>
            </div>
            <div id="fileList" class="divide-y divide-gray-100">
                <div class="p-8 text-center text-gray-400">加载中...</div>
            </div>
        </div>
    </main>

    <script>
        let currentPath = '/';
        
        async function loadFiles(path) {
            currentPath = path;
            updateBreadcrumbs(path);
            const listEl = document.getElementById('fileList');
            
            try {
                // 请求当前路径的 PROPFIND
                const res = await fetch(path, { method: 'PROPFIND', headers: { 'Depth': '1' } });
                
                if (res.status === 401) {
                    // 触发浏览器原生 Basic Auth 弹窗
                    window.location.reload(); 
                    return;
                }

                const text = await res.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                const responses = Array.from(xml.getElementsByTagNameNS('*', 'response'));

                // 解析 XML (过滤掉自己)
                const files = responses.slice(1).map(r => {
                    const href = r.getElementsByTagNameNS('*', 'href')[0].textContent;
                    // 解码并处理路径，移除末尾斜杠
                    let cleanHref = decodeURIComponent(href);
                    if (cleanHref.endsWith('/') && cleanHref.length > 1) cleanHref = cleanHref.slice(0, -1);
                    
                    const name = cleanHref.split('/').pop();
                    const props = r.getElementsByTagNameNS('*', 'prop')[0];
                    const isDir = props.getElementsByTagNameNS('*', 'resourcetype')[0].getElementsByTagNameNS('*', 'collection').length > 0;
                    const size = props.getElementsByTagNameNS('*', 'getcontentlength')[0]?.textContent || 0;
                    
                    return { name, path: cleanHref, isDir, size };
                });

                renderList(files);

            } catch (e) {
                listEl.innerHTML = `<div class="p-8 text-center text-red-500">加载失败: ${e.message}</div>`;
            }
        }

        function renderList(files) {
            const listEl = document.getElementById('fileList');
            if (files.length === 0) {
                listEl.innerHTML = `<div class="p-8 text-center text-gray-400">空文件夹</div>`;
                return;
            }
            
            listEl.innerHTML = files.map(f => `
                <div class="grid grid-cols-12 gap-4 px-6 py-3 items-center hover:bg-gray-50 group text-sm">
                    <div class="col-span-8 flex items-center truncate">
                        <i data-lucide="${f.isDir ? 'folder' : 'file'}" class="w-5 h-5 mr-3 ${f.isDir ? 'text-yellow-500 fill-yellow-500' : 'text-gray-400'}"></i>
                        <a href="javascript:void(0)" onclick="${f.isDir ? `loadFiles('${f.path}')` : `window.open('${f.path}')`}" class="hover:text-blue-600 truncate">${f.name}</a>
                    </div>
                    <div class="col-span-2 text-right text-gray-400 hidden md:block font-mono text-xs">${f.isDir ? '-' : formatSize(f.size)}</div>
                    <div class="col-span-2 text-right opacity-0 group-hover:opacity-100 transition">
                        <button onclick="deleteFile('${f.path}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function handleUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const target = currentPath === '/' ? `/${file.name}` : `${currentPath}/${file.name}`;
            await fetch(target, { method: 'PUT', body: file });
            alert('上传成功');
            loadFiles(currentPath);
            input.value = '';
        }

        async function deleteFile(path) {
            if(!confirm('删除?')) return;
            await fetch(path, { method: 'DELETE' });
            loadFiles(currentPath);
        }

        function updateBreadcrumbs(path) {
            const parts = path.split('/').filter(Boolean);
            let html = `<a href="javascript:void(0)" onclick="loadFiles('/')" class="hover:text-blue-600 font-medium">首页</a>`;
            let acc = '';
            parts.forEach(p => {
                acc += '/' + p;
                html += ` <span class="mx-1">/</span> <a href="javascript:void(0)" onclick="loadFiles('${acc}')" class="hover:text-blue-600">${decodeURIComponent(p)}</a>`;
            });
            document.getElementById('breadcrumbs').innerHTML = html;
        }

        function formatSize(b) {
            if (b==0) return '0 B';
            const i = Math.floor(Math.log(b) / Math.log(1024));
            return (b / Math.pow(1024, i)).toFixed(1) + ' ' + ['B','KB','MB','GB'][i];
        }

        window.onload = () => { lucide.createIcons(); loadFiles('/'); };
    </script>
</body>
</html>
